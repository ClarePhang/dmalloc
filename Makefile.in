#
# Copyright 1993 by the Antaire Corporation
#
# $Id: Makefile.in,v 1.40 1993/12/20 06:30:17 gray Exp $
#

HFLS	= malloc_dbg.h
OBJS	= arg_check.o chunk.o compat.o error.o heap.o malloc.o malloc_lp.o
OBJS_IN	= malloc_lp.o
FILLFLS	= arg_check.c chunk.c error.c heap.c malloc_lp.c malloc_t.c

ARGV	= argv
DEFS	= $(DEFINES)
INCS	= -I. -I$(ARGV) $(INCLUDES)
LIBS	= -L$(ARGV) -l$(ARGV) $(LIBRARIES)

CFLAGS	= -g $(CCFLS) -pipe -W -Wreturn-type -Wunused -Wpointer-arith \
	-Wshadow -Wswitch -Wcomment -Wtrigraphs -Wformat -Wchar-subscripts \
	-Wuninitialized -Wparentheses -Waggregate-return
LDFLAGS	= $(LLDFLAGS)
DESTDIR	= $(ROOT)
TEST	= malloc_t
LIBRARY	= libmalloc_dbg.a
UTIL	= malloc_dbg

MANFILE	= malloc.info

PORTFLS	=  conf.h.in const.h.in Makefile.all.in configure configure.in \
	configure.help \
	ChangeLog Manifest NEWS NOTES README TODO mallocrc \
	arg_check.[ch] chunk.[ch] chunk_loc.h compat.[ch] dbg_tokens.h \
	dbg_values.h error.[ch] error_str.h error_val.h heap.[ch] malloc.c \
	malloc_dbg.c malloc_dbg.[12] malloc_lp.[ch] malloc_loc.h return.h \
	version.h malloc_t.c \
	malloc.info malloc.texi malloc.ps texinfo.tex
PORTCFG	= contrib/README contrib/dec_notes contrib/ra_info.pl

PARTS	= 1 2 3 4 5 6 7
MAXPART	= 7
# NOTE: the wc level should be below 90k due to shar overhead
SHAR1	= conf.h.in const.h.in Makefile.in configure configure.in \
	configure.help \
	ChangeLog Manifest
SHAR2	= chunk.[ch] chunk_loc.h
SHAR3	= NEWS NOTES README TODO mallocrc \
	arg_check.[ch] compat.[ch] dbg_tokens.h \
	dbg_values.h error.[ch] error_str.h error_val.h heap.[ch] \
	malloc_lp.c
SHAR4	= malloc_lp.h malloc_loc.h return.h \
	version.h malloc_t.c malloc.info
SHAR5	= malloc_dbg.c malloc_dbg.[12] \
	malloc.texi
SHAR6	= contrib contrib/README contrib/dec_notes contrib/ra_info.pl \
	malloc.c \
	argv \
	argv/ChangeLog argv/Makefile.in argv/Manifest argv/NOTES \
	argv/README argv/TODO \
	argv/argv.c argv/argv.h.[12] 
SHAR7	= argv/argv_loc.h argv/argv_test.c argv/argv_type.h \
	argv/argv_util.[ch] argv/queue.h argv/version.h \
	argv/compat.[ch] argv/configure.in argv/configure argv/conf.h.in \
	argv/const.h.in \
	argv/argv.info argv/argv.texi

.PHONY : all
all : $(LIBRARY) $(UTIL)

.PHONY : clobber
clobber :
	rm -f $(LIBRARY) $(TEST) $(UTIL)
	rm -f part.? malloc.head malloc.info malloc_dbg.h

.PHONY : distclean
distclean : clobber
	rm -f configure config.status Makefile conf.h const.h
	rm -rf port

.PHONY : installincs
installincs : $(HFLS)
	install -cev -m 444 $(HFLS) $(DESTDIR)/inc

.PHONY : installlibs
installlibs : installincs $(LIBRARY) $(OBJS_IN) $(MANFILE)
	install -cevr -m 644 $(LIBRARY) $(DESTDIR)/lib
	install -cev -m 444 $(OBJS_IN) $(DESTDIR)/lib
	install -cev -m 444 $(MANFILE) $(DESTDIR)/info

.PHONY : install
install : installlibs $(UTIL)
	install -cev $(UTIL) $(DESTDIR)/bin

# put situation specific lines here
config.status :
	sh ./configure

const.h : const.h.in
	rm -f $@
	sh ./config.status

conf.h : conf.h.in
	rm -f $@
	sh ./config.status

malloc_dbg.h : malloc_dbg.1 const.h malloc_dbg.2
	rm -f $@ $@.t
	cat malloc_dbg.1 const.h malloc_dbg.2 > $@.t
	mv $@.t $@

$(LIBRARY) : $(OBJS)
	ar cr $(LIBRARY) $?
	ranlib $@
	- chmod 660 $@

$(UTIL) : malloc_dbg.o $(ARGV)/lib$(ARGV).a
	rm -f $@
	$(CC) $(LDFLAGS) $@.o $(LIBS)
	mv a.out $@

$(ARGV)/$(ARGV).h :
	( cd $(ARGV) ; $(MAKE) $(ARGV).h )

$(ARGV)/lib$(ARGV).a :
	( cd $(ARGV) ; $(MAKE) )

.PHONY : port
port : $(PORTFLS) $(ARGV)
	@ answer 'Is it okay to remove the $@ directory? '
	rm -rf $@
	mkdir $@ $@/contrib
	cp $(PORTFLS) $@
	cp $(PORTCFG) $@/contrib
	mv $@/Makefile.all.in $@/Makefile.in
	cp -r $(ARGV) $@
	@ echo ''
	@ echo 'Please rename $@ to malloc-version and tar up file'

.PHONY : patch
patch :
	@ echo 'Run fixpatch.pl on the patch file'

.PHONY : fill
fill : $(FILLFLS)
	fillproto $(FILLFLS)

tests : $(TEST)

$(TEST) : $(TEST).o $(LIBRARY) $(ARGV)/lib$(ARGV).a
	rm -f $@
	$(CC) $(LDFLAGS) $(TEST).o $(LIBS) $(LIBRARY)
	mv a.out $@

.PHONY : light
light : $(TEST)
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000

.PHONY : heavy
heavy : $(TEST) light
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000

malloc.ps : malloc.texi
	@ answer 'Is it okay to remove the work directory? '
	rm -rf work
	mkdir work
	( cd work ; texi2dvi ../malloc.texi ; dvips -o ../$@ malloc.dvi )
	rm -rf work

malloc.head : malloc.info
	rm -f $@ $@.t
	sed -e '/^Malloc Debug Library/,/Gray Watson/p' -e 'd' < \
		malloc.info > $@.t
	echo '' >> $@.t
	echo ---------------------------------------------------------------- \
		>> $@.t
	mv $@.t $@

.PHONY : shar
shar : malloc.head
	rm -f part.? part.t
	cd port ; $(foreach part, $(PARTS), \
		shar -n${part} -e${MAXPART} -o../part.${part} -t \
			"Do a 'sh ./configure' to configure the library" \
			${SHAR${part}} ; \
		)
	cat malloc.head part.1 > part.t
	mv part.t part.1

include /usr/antaire/Default.make
include Makefile.dep
