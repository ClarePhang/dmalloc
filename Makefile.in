#
# $Id: Makefile.in,v 1.96 1997/07/07 08:14:50 gray Exp $
#

SHELL	= /bin/sh

srcdir = @srcdir@
VPATH = @srcdir@

HFLS	= dmalloc.h
OBJS	= arg_check.o chunk.o compat.o dmalloc_lp.o env.o error.o heap.o \
	malloc.o
# NOTE:
# not argv.c because from argv module
# not compat.c because of HAVE_...,
# not dmalloc.c cause no associated .h file dmalloc.h
FILLFLS	= arg_check.c chunk.c dmalloc_lp.c dmalloc_t.c env.c heap.c malloc.c
DOCS	= dmalloc.texi dmalloc.info dmalloc.ps

DEFS	= -DHAVE_STDLIB_H=@HAVE_STDLIB_H@ \
	-DHAVE_STRING_H=@HAVE_STRING_H@ \
	-DHAVE_UNISTD_H=@HAVE_UNISTD_H@ $(DEFINES)
INCS	= -I. -I$(srcdir) $(INCLUDES)
LIBS	= $(LIBRARIES)

CFLAGS	= -g $(CCFLS) -W -Wunused -Wpointer-arith \
	-Wshadow -Wswitch -Wcomment -Wtrigraphs -Wformat -Wchar-subscripts \
	-Wuninitialized -Wparentheses -Waggregate-return
LDFLAGS	= $(LLDFLAGS)
DESTDIR	= /usr/local/local
TEST	= dmalloc_t
LIBRARY	= libdmalloc.a
LIB_DIS	= libdmalloclp.a
UTIL	= dmalloc
INFOFILE= dmalloc.info

#
# WARNING: be careful about the order of this list some files are at
# the end on purpose
#
FLS	=  conf.h.in configure.in config.help \
	ChangeLog Manifest INSTALL PERMISSIONS NEWS NOTES README TODO \
	dmallocrc dmalloc.texi \
	arg_check.[ch] chunk.[ch] chunk_loc.h compat.[ch] debug_tok.h \
	debug_val.h env.[ch] error.[ch] error_str.h error_val.h heap.[ch] \
	malloc.c dmalloc.c dmalloc.h.[13] dmalloc_loc.h dmalloc_lp.[ch] \
	dmalloc_t.c return.h settings.dist version.h \
	argv.[ch] argv_loc.h dmalloc.cc \
	install-sh mkinstalldirs Deansify.pl \
	configure $(INFOFILE)
CFGFLS	= contrib/README contrib/Xmalloc.c contrib/atexit.c \
	contrib/dec_notes contrib/dmalloc_summarize.pl contrib/next_notes \
	contrib/ra_info.pl
DOCFLS	= dmalloc.ps texinfo.tex

# Shar file maximum size
# NOTE: the wc level should be below 90k due to shar overhead
SHARSIZE= 85k

all :: $(LIBRARY) $(LIB_DIS) $(UTIL)

clean ::
	$(CLEAN)
	rm -f $(LIBRARY) $(LIB_DIS) $(TEST) $(UTIL) $(INFOFILE)
	rm -f part.? dmalloc.h
	rm -f INSTALL PERMISSIONS README README_ftp

distclean :: clean
	rm -f configure config.status config.log config.cache conf.h
	rm -f Makefile dmalloc.h.2 dmalloc.ps dmalloc.dvi settings.h
	rm -rf port

installincs :: $(HFLS)
	install -cev -m 444 $(HFLS) $(DESTDIR)/inc

installlibs :: installincs $(LIBRARY) $(LIB_DIS) $(INFOFILE)
	install -cevr -m 644 $(LIBRARY) $(DESTDIR)/lib
	install -cevr -m 644 $(LIB_DIS) $(DESTDIR)/lib
	install -cev -m 444 $(INFOFILE) $(DESTDIR)/info

install :: installlibs $(UTIL)
	install -cev $(UTIL) $(DESTDIR)/bin

installftp :: README_ftp $(DOCS)
	install -cev -o ftp -g ftp -m 444 README_ftp ftp/README
	install -cev -o ftp -g ftp -m 444 $(DOCS) ftp/docs
	cd ftp/docs ; gzip -fv $(DOCS)
	install -cev -o ftp -g ftp -m 444 $(DOCS) ftp/docs

# put situation specific lines here
dmalloc.h.2 : configure
	$(SHELL) configure -v

settings.h : $(srcdir)/settings.dist $(srcdir)/configure
	$(SHELL) $(srcdir)/configure -v

dmalloc.h : $(srcdir)/dmalloc.h.1 dmalloc.h.2 $(srcdir)/dmalloc.h.3
	rm -f $(.TARGET) $(.TARGET).t
	cat $(srcdir)/dmalloc.h.1 dmalloc.h.2 $(srcdir)/dmalloc.h.3 > \
		$(.TARGET).t
	mv $(.TARGET).t $(.TARGET)

$(LIBRARY) : $(OBJS)
	ar cr $(LIBRARY) $?
	ranlib $(.TARGET)

$(LIB_DIS) : dmalloc_lp.o
	ar cr $(LIB_DIS) $?
	ranlib $(.TARGET)

$(UTIL) : dmalloc.o argv.o compat.o env.o
	rm -f $(.TARGET)
	$(CC) $(LDFLAGS) $(UTIL).o argv.o compat.o env.o $(LIBS)
	mv a.out $(.TARGET)

port :: $(FLS) $(DOCFLS) $(CFGFLS) Makefile.all.in
	@ answer 'Is it okay to remove the $(.TARGET) directory? '
	rm -rf $(.TARGET)
	mkdir $(.TARGET) $(.TARGET)/contrib
	cp $(FLS) Makefile.all.in $(.TARGET)
	cp $(DOCFLS) $(.TARGET)
	cp $(CFGFLS) $(.TARGET)/contrib
	mv $(.TARGET)/Makefile.all.in $(.TARGET)/Makefile.in
	@ echo ''
	@ echo 'Please rename $(.TARGET) to dmalloc-version and tar up file'

patch ::
	@ echo 'Run fixpatch.pl on the patch file'

fill :: $(FILLFLS)
	fillproto $(FILLFLS)

tests :: $(TEST)

$(TEST) : $(TEST).o argv.o $(LIBRARY)
	rm -f $(.TARGET)
	$(CC) $(LDFLAGS) $(TEST).o argv.o $(LIBS) $(LIBRARY)
	mv a.out $(.TARGET)

check light :: $(TEST)
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000
	$(TEST) -s -t 10000

heavy :: $(TEST) light
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000
	$(TEST) -s -t 100000

continuous :: $(TEST)
	while test 1 ;\
		do  (\
			$(TEST) -n -t 100000 ;\
			sleep 1 ;\
		); done

dmalloc.ps : dmalloc.texi
	rm -rf work
	mkdir work
	( cd work ; texi2dvi ../dmalloc.texi ; \
		dvips -o ../$(.TARGET) dmalloc.dvi )
	rm -rf work

dmalloc.dvi : dmalloc.texi
	rm -rf work
	mkdir work
	( cd work ; texi2dvi ../dmalloc.texi ; mv dmalloc.dvi .. )
	rm -rf work

INSTALL : $(srcdir)/INSTALL.1 $(INFOFILE)
	rm -f $(.TARGET) $(.TARGET).t
	cp $(srcdir)/INSTALL.1 $(.TARGET).t
	sed -e '1,/,  Node: Installation/d' \
		-e '/,  Node: Getting Started/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		>> $(.TARGET).t
	sed -e '1,/,  Node: Getting Started/d' \
		-e '/,  Node: Details/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		>> $(.TARGET).t
	mv $(.TARGET).t $(.TARGET)

PERMISSIONS : $(INFOFILE)
	rm -f $(.TARGET) $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		> $(.TARGET).t
	sed -e '1,/,  Node: Copying/d' \
		-e '/,  Node: Overview/,$$d' \
		-e '/^\* Menu/,/^File: $(INFOFILE)/d' \
		-e '/^File: $(INFOFILE)/d' < \
		$(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		>> $(.TARGET).t
	mv $(.TARGET).t $(.TARGET)

README : $(srcdir)/README.1 $(INFOFILE)
	rm -f $(.TARGET) $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		> $(.TARGET).t
	sed -e '1,/,  Node: Top/d' -e '/\* Menu:/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		>> $(.TARGET).t
	sed -e '1,/,  Node: How To Get/d' -e '/,  Prev: How To Get/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	cat $(srcdir)/README.1 >> $(.TARGET).t
	mv $(.TARGET).t $(.TARGET)

README_ftp : $(srcdir)/README_ftp.1 $(INFOFILE)
	rm -f $(.TARGET) $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		> $(.TARGET).t
	sed -e '1,/,  Node: Top/d' -e '/\* Menu:/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	echo ------------------------------------------------------------------------------- \
		>> $(.TARGET).t
	sed -e '1,/,  Node: How To Get/d' -e '/,  Prev: How To Get/,$$d' \
		< $(INFOFILE) | tr -d '\037'  >> $(.TARGET).t
	cat $(srcdir)/README_ftp.1 >> $(.TARGET).t
	mv $(.TARGET).t $(.TARGET)

$(INFOFILE) : $(srcdir)/dmalloc.texi
	rm -f $(.TARGET)
	makeinfo --no-split $(.OODATE)

shar :: $(FLS) $(CFGFLS)
	rm -f part.?? part.t Makefile.in.bak
	mv Makefile.in Makefile.in.bak
	cp Makefile.all.in Makefile.in
	makekit -n part. -s ${SHARSIZE} \
		-t "See the INSTALL file for instructions on building and installing the library." \
		$(FLS) Makefile.in $(CFGFLS)
	rm -f Makefile.in
	mv Makefile.in.bak Makefile.in
	sed -e '1,/,  Node: Top/d' -e '/\* Menu:/,$$d' \
		< $(INFOFILE) | tr -d '\037'  > part.t
	echo ---------------------------------------------------------------- \
		>> part.t
	cat part.01 >> part.t
	mv part.t part.01

#
# auto configure settings
#
Makefile : $(srcdir)/Makefile.in
	$(SHELL) config.status

conf.h : $(srcdir)/conf.h.in
	$(SHELL) config.status

config.status : $(srcdir)/configure
	$(SHELL) config.status --recheck

$(srcdir)/configure : $(srcdir)/configure.in
	cd $(srcdir); autoconf

.include <local.mk>
